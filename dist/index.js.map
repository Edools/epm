{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["(function (global, factory) {\n  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('s3'), require('q'), require('rest'), require('rest/interceptor/pathPrefix'), require('rest/interceptor/mime'), require('rest/interceptor/defaultRequest'), require('rest/interceptor/errorCode'), require('ramda'), require('through2')) :\n  typeof define === 'function' && define.amd ? define(['exports', 's3', 'q', 'rest', 'rest/interceptor/pathPrefix', 'rest/interceptor/mime', 'rest/interceptor/defaultRequest', 'rest/interceptor/errorCode', 'ramda', 'through2'], factory) :\n  factory((global.index.js = {}), global.s3, global.Q, global.rest, global.pathPrefix, global.mime, global.defaultRequest, global.errorCode, global.R, global.through)\n}(this, function (exports, s3, Q, rest, pathPrefix, mime, defaultRequest, errorCode, R, through) { 'use strict';\n\n  Q = ('default' in Q ? Q['default'] : Q);\n  rest = ('default' in rest ? rest['default'] : rest);\n  pathPrefix = ('default' in pathPrefix ? pathPrefix['default'] : pathPrefix);\n  mime = ('default' in mime ? mime['default'] : mime);\n  defaultRequest = ('default' in defaultRequest ? defaultRequest['default'] : defaultRequest);\n  errorCode = ('default' in errorCode ? errorCode['default'] : errorCode);\n  R = ('default' in R ? R['default'] : R);\n  through = ('default' in through ? through['default'] : through);\n\n  class Source {\n    constructor (file, release, config) {\n      this.file        = file;\n      this.release     = release;\n      this.config      = config;\n      this.client      = this.createS3Client(config);\n    }\n\n    get remoteKey () {\n      let release = this.release;\n      return `libs/edools-school/${release.app}/${release.version}/${this.file.relative}`;\n    }\n\n    createS3Client (config) {\n      return s3.createClient({\n        s3Options: config.s3Options\n      });\n    }\n\n    upload () {\n      let deferred = Q.defer();\n      let uploader = this.client.uploadFile({\n        localFile: this.file.base + this.file.relative,\n        s3Params: {\n          Bucket: this.config.s3Options.bucket,\n          Key: this.remoteKey,\n          ACL: 'public-read'\n        }\n      });\n\n      uploader.on('progress', () => {\n        deferred.notify(uploader.progressAmount);\n      });\n      uploader.on('error', deferred.reject);\n      uploader.on('end', deferred.resolve);\n\n      return deferred.promise;\n    }\n  }\n\n  function getDefaultHeaders(config) {\n    return {\n      Accept: 'application/vnd.edools.themes.v1+json',\n      Authorization: `Token token=${config.token}`\n  };\n  }\n\n  function restClient(config) {\n    return rest.wrap(mime)\n               .wrap(pathPrefix, { prefix: 'https://api.myedools.com' })\n               .wrap(defaultRequest, { headers: getDefaultHeaders(config) })\n               .wrap(errorCode, { code: 400 })\n               .wrap(errorCode, { code: 404 })\n               .wrap(errorCode, { code: 500 });\n  }\n\n  class ThemeClient {\n    constructor (config) {\n      this.client = restClient(config);\n    }\n\n    update (theme) {\n      return this.client({\n        method: 'PUT',\n        path: `/themes/${theme.id}`,\n        entity: { theme: theme },\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n  }\n\n  class ReleaseClient {\n    constructor (config) {\n      this.client = restClient(config);\n    }\n\n    getOne (release) {\n      return this.client(`/apps/${release.app}/releases/${release.version}`);\n    }\n\n    getList (app) {\n      return this.client(`/apps/${app}/releases`);\n    }\n\n    create (release) {\n      return this.client({\n        method: 'POST',\n        path: `/apps/${release.app}/releases`,\n        entity: { app_release: release },\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    update (release) {\n      return this.client({\n        method: 'PUT',\n        path: `/apps/${release.app}/releases/${release.version}`,\n        entity: { app_release: release },\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n\n    remove (release) {\n      return this.client({\n        method: 'DELETE',\n        path: `/apps/${release.app}/releases/${release.version}`\n    });\n    }\n  }\n\n\n\n  class Release {\n    constructor (config) {\n      Object.assign(this, { app: config.app });\n      Object.assign(this, config.manifest);\n      this.client       = new ReleaseClient(config);\n    }\n\n    save () {\n      return this.exists()\n        .then(() => this.client.update(this))\n        .catch(() => this.client.create(this));\n    }\n\n    exists () {\n      var deferred = Q.defer();\n\n      this.client.getOne(this)\n        .then(deferred.resolve)\n        .catch(deferred.reject);\n\n      return deferred.promise;\n    }\n  }\n\n\n\n  class AppHandler {\n    static deploy (config, files) {\n      let release = new Release(config),\n          sources = R.map(file => new Source(file, release, config), files);\n\n      return Q.all(R.map(source => source.upload(), sources))\n              .then(() => release.save());\n    }\n  }\n\n  exports.AppHandler = AppHandler;\n\n  function edoolsApps(config) {\n    return through.obj((file, enc, cb) => {\n      AppHandler.deploy(config, [file])\n        .then(() => cb(null, file))\n        .catch((err) => {\n          throw err;\n        });\n    });\n  }\n\n  exports.AppStream = edoolsApps;\n\n  class Theme {\n    constructor (config) {\n      this.id = config.id;\n      this.package_url = config.package_url;\n      this.client = new ThemeClient(config);\n    }\n\n    deploy (dependencies) {\n      this.dependencies = dependencies;\n      return this.client.update(this);\n    }\n  }\n\n  class DepsResolver {\n    constructor (config) {\n      this.releaseClient = new ReleaseClient(config);\n    }\n\n    resolve (dependencies) {\n      return this.getDeps(dependencies)\n        .then(deps => this.format(deps));\n    }\n\n    getDeps (dependencies) {\n      return Q.all(R.map(dep => {\n        return this.releaseClient.getOne(dep)\n          .then(res => res.entity);\n      }, this.depsToArray(dependencies)));\n    }\n\n    depsToArray (dependencies) {\n      return R.map(key => {\n        return { app: key, version: dependencies[key] };\n      }, R.keys(dependencies));\n    }\n\n    format (dependencies) {\n      dependencies = R.concat(dependencies, this.getSubDeps(dependencies));\n\n      return R.reduce((acc, dep) => {\n        acc[dep.app || dep.name] = dep.version;\n        return acc;\n      }, {}, dependencies);\n    }\n\n    getSubDeps (dependencies) {\n      let subDeps = R.reduce((acc, dep) => {\n        return R.concat(acc, this.depsToArray(dep.dependencies));\n      }, [], dependencies);\n\n      subDeps = R.uniqWith((dep1, dep2) => dep1.app === dep2.app, subDeps);\n      subDeps = R.filter(subDep => !R.contains(subDep.app, R.map(R.prop('name'), dependencies)), subDeps);\n      return subDeps;\n    }\n  }\n\n\n\n  class ThemeHandler {\n    static deploy (config) {\n      let theme = new Theme(config),\n        depsResolver = new DepsResolver(config);\n\n      return depsResolver.resolve(config.dependencies)\n        .then(dependencies => theme.deploy(dependencies))\n        .catch((err) => {\n          throw err;\n        });\n    }\n  }\n\n  exports.ThemeHandler = ThemeHandler;\n\n\n\n}));\n"],"sourceRoot":"/source/"}